/**
 * @file parcel.c
 * @author Jason Conway (jpc@jasonconway.dev)
 * @brief Entry point for parcel client
 * @version 0.9.1
 * @date 2022-01-15
 *
 * @copyright Copyright (c) 2022 Jason Conway. All rights reserved.
 *
 */

// TODO: console - dynamically allocate and resize main buffer as needed
// TODO: console - return a "back" code when backspacing on nothing
// TODO: console - utf-8 decoder? (Windows)
// TODO: test file sending both platforms

#include "client.h"

static void catch_sigint(int sig)
{
	(void)sig;
	xprintf(RED, "\nAborting application\n");
	exit(EXIT_FAILURE);
}

static void splash(void)
{
	static const char logo[] = {
		0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
		0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
		0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
		0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
		0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0xe2, 0xa2, 0x80, 0xe2, 0xa3, 0x80,
		0xe2, 0xa1, 0x80, 0x20, 0x20, 0x20, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x20,
		0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
		0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
		0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
		0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
		0x20, 0xe2, 0xa3, 0xbf, 0xe2, 0xa3, 0xbf, 0xe2, 0xa1, 0x87, 0x20, 0x20,
		0x20, 0x0a, 0x20, 0x20, 0x20, 0xe2, 0xa3, 0x80, 0xe2, 0xa3, 0xa4, 0xe2,
		0xa3, 0xa4, 0xe2, 0xa3, 0xa4, 0xe2, 0xa3, 0xa4, 0xe2, 0xa3, 0xa4, 0xe2,
		0xa3, 0xa4, 0xe2, 0xa3, 0x80, 0x20, 0x20, 0x20, 0x20, 0xe2, 0xa3, 0xa4,
		0xe2, 0xa3, 0xa4, 0xe2, 0xa3, 0xa4, 0xe2, 0xa3, 0xa4, 0xe2, 0xa3, 0xa4,
		0xe2, 0xa3, 0xa4, 0xe2, 0xa1, 0x80, 0x20, 0x20, 0x20, 0xe2, 0xa2, 0x80,
		0xe2, 0xa3, 0xa4, 0xe2, 0xa3, 0xa4, 0xe2, 0xa3, 0xa4, 0xe2, 0xa3, 0xa4,
		0xe2, 0xa3, 0xa4, 0xe2, 0xa3, 0xa4, 0x20, 0x20, 0xe2, 0xa3, 0x80, 0xe2,
		0xa3, 0xa4, 0xe2, 0xa3, 0xa4, 0xe2, 0xa3, 0xa4, 0xe2, 0xa3, 0xa4, 0xe2,
		0xa3, 0xa4, 0xe2, 0xa3, 0xa4, 0xe2, 0xa3, 0x84, 0x20, 0x20, 0xe2, 0xa3,
		0x80, 0xe2, 0xa3, 0xa4, 0xe2, 0xa3, 0xa4, 0xe2, 0xa3, 0xa4, 0xe2, 0xa3,
		0xa4, 0xe2, 0xa3, 0xa4, 0xe2, 0xa3, 0xa4, 0xe2, 0xa3, 0x80, 0x20, 0x20,
		0xe2, 0xa3, 0xbf, 0xe2, 0xa3, 0xbf, 0xe2, 0xa1, 0x87, 0x20, 0x20, 0x20,
		0x0a, 0x20, 0x20, 0xe2, 0xa3, 0xbc, 0xe2, 0xa3, 0xbf, 0xe2, 0xa1, 0x9f,
		0xe2, 0xa0, 0x9b, 0xe2, 0xa0, 0x9b, 0xe2, 0xa0, 0x9b, 0xe2, 0xa0, 0x9b,
		0xe2, 0xa2, 0xbb, 0xe2, 0xa3, 0xbf, 0xe2, 0xa3, 0xa7, 0x20, 0x20, 0x20,
		0xe2, 0xa0, 0x9b, 0xe2, 0xa0, 0x9b, 0xe2, 0xa0, 0x9b, 0xe2, 0xa0, 0x9b,
		0xe2, 0xa0, 0x9b, 0xe2, 0xa2, 0xbb, 0xe2, 0xa3, 0xbf, 0xe2, 0xa1, 0x86,
		0x20, 0xe2, 0xa2, 0xb0, 0xe2, 0xa3, 0xbf, 0xe2, 0xa1, 0x9f, 0xe2, 0xa0,
		0x9b, 0xe2, 0xa0, 0x9b, 0xe2, 0xa0, 0x9b, 0xe2, 0xa0, 0x9b, 0xe2, 0xa0,
		0x9b, 0x20, 0xe2, 0xa3, 0xbc, 0xe2, 0xa3, 0xbf, 0xe2, 0xa1, 0x9f, 0xe2,
		0xa0, 0x9b, 0xe2, 0xa0, 0x9b, 0xe2, 0xa0, 0x9b, 0xe2, 0xa0, 0x9b, 0xe2,
		0xa0, 0x9b, 0xe2, 0xa0, 0x9b, 0x20, 0xe2, 0xa2, 0xb0, 0xe2, 0xa3, 0xbf,
		0xe2, 0xa1, 0x9f, 0xe2, 0xa0, 0x9b, 0xe2, 0xa0, 0x9b, 0xe2, 0xa0, 0x9b,
		0xe2, 0xa0, 0x9b, 0xe2, 0xa0, 0xbb, 0xe2, 0xa3, 0xbf, 0xe2, 0xa3, 0xa7,
		0x20, 0xe2, 0xa3, 0xbf, 0xe2, 0xa3, 0xbf, 0xe2, 0xa1, 0x87, 0x20, 0x20,
		0x20, 0x0a, 0x20, 0x20, 0xe2, 0xa3, 0xbf, 0xe2, 0xa3, 0xbf, 0xe2, 0xa1,
		0x87, 0x20, 0x20, 0x20, 0x20, 0xe2, 0xa2, 0xb8, 0xe2, 0xa3, 0xbf, 0xe2,
		0xa3, 0xbf, 0x20, 0xe2, 0xa3, 0xb0, 0xe2, 0xa3, 0xbe, 0xe2, 0xa3, 0xbf,
		0xe2, 0xa0, 0xbf, 0xe2, 0xa0, 0xbf, 0xe2, 0xa0, 0xbf, 0xe2, 0xa1, 0x87,
		0xe2, 0xa2, 0xb8, 0xe2, 0xa3, 0xbf, 0xe2, 0xa1, 0x87, 0x20, 0xe2, 0xa2,
		0xb8, 0xe2, 0xa3, 0xbf, 0xe2, 0xa1, 0x87, 0x20, 0x20, 0x20, 0x20, 0x20,
		0x20, 0xe2, 0xa3, 0xbf, 0xe2, 0xa3, 0xbf, 0xe2, 0xa1, 0x87, 0x20, 0x20,
		0x20, 0x20, 0x20, 0x20, 0x20, 0xe2, 0xa2, 0xb8, 0xe2, 0xa3, 0xbf, 0xe2,
		0xa1, 0x87, 0xe2, 0xa3, 0xb4, 0xe2, 0xa3, 0xb6, 0xe2, 0xa3, 0xb6, 0xe2,
		0xa3, 0xb6, 0xe2, 0xa3, 0xbe, 0xe2, 0xa3, 0xbf, 0xe2, 0xa0, 0x8f, 0x20,
		0xe2, 0xa3, 0xbf, 0xe2, 0xa3, 0xbf, 0xe2, 0xa1, 0x87, 0x20, 0x20, 0x20,
		0x0a, 0x20, 0x20, 0xe2, 0xa3, 0xbf, 0xe2, 0xa3, 0xbf, 0xe2, 0xa1, 0x87,
		0xe2, 0xa3, 0x80, 0xe2, 0xa3, 0x80, 0xe2, 0xa3, 0x80, 0xe2, 0xa3, 0x80,
		0xe2, 0xa3, 0xb8, 0xe2, 0xa3, 0xbf, 0xe2, 0xa1, 0x9f, 0x20, 0xe2, 0xa3,
		0xbf, 0xe2, 0xa3, 0xbf, 0xe2, 0xa3, 0x84, 0xe2, 0xa3, 0x80, 0xe2, 0xa3,
		0x80, 0xe2, 0xa3, 0x80, 0xe2, 0xa3, 0x80, 0xe2, 0xa3, 0xbc, 0xe2, 0xa3,
		0xbf, 0xe2, 0xa1, 0x87, 0x20, 0xe2, 0xa2, 0xb8, 0xe2, 0xa3, 0xbf, 0xe2,
		0xa1, 0x87, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0xe2, 0xa2, 0xbf, 0xe2,
		0xa3, 0xbf, 0xe2, 0xa3, 0x87, 0xe2, 0xa3, 0x80, 0xe2, 0xa3, 0x80, 0xe2,
		0xa3, 0x80, 0xe2, 0xa3, 0x80, 0xe2, 0xa3, 0x80, 0xe2, 0xa3, 0x80, 0x20,
		0xe2, 0xa2, 0xb8, 0xe2, 0xa3, 0xbf, 0xe2, 0xa3, 0x87, 0xe2, 0xa3, 0x89,
		0xe2, 0xa3, 0x89, 0xe2, 0xa3, 0x89, 0xe2, 0xa3, 0x89, 0xe2, 0xa0, 0x89,
		0xe2, 0xa0, 0x81, 0x20, 0x20, 0xe2, 0xa2, 0xbb, 0xe2, 0xa3, 0xbf, 0xe2,
		0xa3, 0xa7, 0xe2, 0xa3, 0x80, 0x20, 0x20, 0x0a, 0x20, 0x20, 0xe2, 0xa3,
		0xbf, 0xe2, 0xa3, 0xbf, 0xe2, 0xa1, 0x87, 0xe2, 0xa0, 0xbf, 0xe2, 0xa0,
		0xbf, 0xe2, 0xa0, 0xbf, 0xe2, 0xa0, 0xbf, 0xe2, 0xa0, 0x9f, 0xe2, 0xa0,
		0x8b, 0x20, 0x20, 0xe2, 0xa0, 0x88, 0xe2, 0xa0, 0x9b, 0xe2, 0xa0, 0xbf,
		0xe2, 0xa0, 0xbf, 0xe2, 0xa0, 0xbf, 0xe2, 0xa0, 0xbf, 0xe2, 0xa0, 0xbf,
		0xe2, 0xa0, 0x9f, 0xe2, 0xa0, 0x8b, 0x20, 0x20, 0xe2, 0xa0, 0xb8, 0xe2,
		0xa0, 0xbf, 0xe2, 0xa0, 0x87, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0xe2,
		0xa0, 0x88, 0xe2, 0xa0, 0x99, 0xe2, 0xa0, 0xbb, 0xe2, 0xa0, 0xbf, 0xe2,
		0xa0, 0xbf, 0xe2, 0xa0, 0xbf, 0xe2, 0xa0, 0xbf, 0xe2, 0xa0, 0xbf, 0xe2,
		0xa0, 0x9f, 0x20, 0x20, 0xe2, 0xa0, 0x99, 0xe2, 0xa0, 0xbb, 0xe2, 0xa0,
		0xbf, 0xe2, 0xa0, 0xbf, 0xe2, 0xa0, 0xbf, 0xe2, 0xa0, 0xbf, 0x20, 0x20,
		0x20, 0x20, 0x20, 0xe2, 0xa0, 0x99, 0xe2, 0xa0, 0xbb, 0xe2, 0xa0, 0xbf,
		0x20, 0x20, 0x0a, 0x20, 0x20, 0xe2, 0xa3, 0xbf, 0xe2, 0xa3, 0xbf, 0xe2,
		0xa0, 0x87, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
		0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
		0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
		0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
		0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x0a, 0x20, 0x20,
		0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
		0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
		0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
		0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
		0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20
	};
	
	// static const char logo[] = {
	// 	"                                 ⣠⣄     \n"
	// 	"                             ⢀⣴⣄⣼⠟⠻⣷⣄   \n"
	// 	"                            ⣴⣿⣿⣿⣿⣆⡀⢈⣻⡷  \n"
	// 	"                          ⢀⣠⣿⢿⣿⣿⣿⣿⣿⣟⠋   \n"
	// 	"                   ⣤⣶⠿⠿⠿⠷⠾⠟⠋  ⠙⢿⣿⣿⣿⡟⠃   \n"
	// 	"                ⢀⣰⡿⠋  ⢀⣠⣤⣄⡀   ⣠⣾⠟⠟⠁     \n"
	// 	"              ⢀⣰⡾⠋   ⣠⣾⠏⠉⣹⣷⢠⣶⢠⣿⠁        \n"
	// 	"            ⢀⣰⡾⠋   ⣠⡾⠋⢿⣧⣾⣟⣡⣾⠏⢸⣿         \n"
	// 	"           ⣤⡿⠋   ⣠⡿⠋   ⠙⣻⣿⠟⠁ ⢀⣿         \n"
	// 	"         ⣤⡿⠋   ⣠⡾⠋    ⣠⣾⠟⠁  ⣠⣾⠏         \n"
	// 	"⠾⠷⣦⣤⣴⠾⢿⣶⣿⣯⣶⣿⣷⣶⣾⣿⡾⠿⣶⣤⣤⣾⣿⣷⣦⣤⣴⣾⠿⢷⣤⣤⡶⠿⠷⣦⣤⣴⠶⠷\n"
	// 	"  ⠈⠉⢁⣰⣾⣿⣿⣿⣿⣿⡿⠋⠉⠁  ⣠⣿⣿⣿⣿⣿⣿⣿⠟⠁  ⠉⠉   ⠈⠉⠁  \n"
	// 	"    ⢸⣿⣿⣿⣿⣿⡿⠋    ⣠⣾⣿⣿⣿⣿⣿⣿⠟⠁              \n"
	// 	"    ⠘⢻⣿⣿⣿⣿⡅   ⣠⣾⣿⣿⣿⣿⣿⣿⠟⠁                \n"
	// 	"      ⠘⢻⣿⣿⣿⣶⣶⣾⣿⣿⣿⣿⣿⣿⠟⠁                  \n"
	// 	"        ⠉⠿⣿⣿⣿⣿⣿⣿⣿⣿⠟⠁                    \n"
	// 	"          ⠉⠿⣿⣿⣿⣿⠟⠁                      \n"
	// 	"            ⠉⠛⠋⠁                        "
	// };
	xprintf(BLU, "%s", logo);
	(void)fputc('\n', stdout);
}

static void usage(FILE *f)
{
	static const char usage[] =
		"usage: parcel [-hd] [-a ADDR] [-p PORT] [-u NAME]\n"
		"  -a ADDR  server address (www.example.com, 111.222.333.444)\n"
		"  -p PORT  server port (3724, 9216)\n"
		"  -u NAME  username displayed alongside sent messages\n"
		"  -l       use computer login as username\n"
		"  -h       print this usage information\n";
	fprintf(f, "%s", usage);
}

int main(int argc, char **argv)
{
	signal(SIGINT, catch_sigint);
	splash();

	char address[ADDRESS_MAX_LENGTH];
	memset(address, 0, ADDRESS_MAX_LENGTH);
	
	char port[PORT_MAX_LENGTH] = "2315";
	
	client_t *client = xcalloc(sizeof(client_t));
	if (!client) {
		fatal("xmalloc()");
	}

	pthread_mutex_init(&client->mutex_lock, NULL);

	int option;
	xgetopt_t x = { 0 };
	while ((option = xgetopt(&x, argc, argv, "lha:p:u:")) != -1) {
		switch (option) {
			case 'a':
				if (strlen(x.arg) < ADDRESS_MAX_LENGTH) {
					memcpy(address, x.arg, strlen(x.arg));
					break;
				}
				fatal("server address too long");
			case 'p':
				if (xport_valid(x.arg)) {
					memcpy(port, x.arg, strlen(x.arg));
					break;
				}
				exit(EXIT_FAILURE);
			case 'u':
				if (strlen(x.arg) < USERNAME_MAX_LENGTH) {
					memcpy(client->username, x.arg, strlen(x.arg));
					break;
				}
				fatal("username too long");
			case 'l': 
				if (xgetlogin(client->username, USERNAME_MAX_LENGTH)) {
					fatal("unable to determine login name");
				}
				break;
			case 'h':
				usage(stdout);
				exit(EXIT_SUCCESS);
			case ':':
				printf("> Option is missing an argument\n");
				exit(EXIT_FAILURE);
		}
	}
	
	if (argc < 5) {
		prompt_args(address, client->username);
	}
	
	connect_server(client, address, port);
	pthread_t recv_ctx;
	pthread_create(&recv_ctx, NULL, recv_thread, (void *)client);

	// Handle sending from main thread
	return send_thread((void *)client);
}
